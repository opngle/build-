name: Build OpenSSL for Windows

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-openssl:
    runs-on: windows-latest

    env:
      # Suppress Perl uninitialized warnings
      PERL5OPT: -w0
      # Relative output directory for installation
      BUILD_DIR: ${{ github.workspace }}/openssl_build
      # Control static or dynamic build: 'shared' or 'static'
      OPENSSL_BUILD_TYPE: shared

    steps:
      # 1️⃣ Get the latest stable OpenSSL release from GitHub
      - name: Get latest OpenSSL release
        id: get_release
        shell: bash
        run: |
          # Fetch releases, filter out prerelease, get the latest tag
          LATEST=$(curl -s https://api.github.com/repos/openssl/openssl/releases \
            | jq -r 'map(select(.prerelease==false))[0].tag_name')
          echo "OPENSSL_VERSION=$LATEST" >> $GITHUB_ENV
          echo "Latest OpenSSL version detected: $LATEST"

      # 2️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3️⃣ Install Strawberry Perl (ignore attestation verification)
      - name: Install Perl (Strawberry)
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.36'
          verify: false

      # 4️⃣ Setup Visual Studio MSVC environment
      - name: Setup Visual Studio MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 5️⃣ Download OpenSSL source
      - name: Download OpenSSL source
        shell: bash
        run: |
          echo "Downloading OpenSSL $OPENSSL_VERSION"
          curl -L -o openssl.tar.gz \
            https://github.com/openssl/openssl/releases/download/${OPENSSL_VERSION}/openssl-${OPENSSL_VERSION}.tar.gz
          tar -xf openssl.tar.gz
          mv openssl-${OPENSSL_VERSION} openssl

      # 6️⃣ Configure OpenSSL build
      - name: Configure OpenSSL
        working-directory: openssl
        shell: cmd
        run: |
          if "%OPENSSL_BUILD_TYPE%"=="static" (
            perl Configure VC-WIN64A ^
              --