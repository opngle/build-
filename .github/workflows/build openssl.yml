name: Build OpenSSL for Windows

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-openssl:
    runs-on: windows-latest

    env:
      # Suppress Perl uninitialized warnings
      PERL5OPT: -w0
      # Relative output directory for installation
      BUILD_DIR: ${{ github.workspace }}/openssl_build
      # Control static or dynamic build: 'shared' or 'static'
      OPENSSL_BUILD_TYPE: shared

    steps:
      # 1Ô∏è‚É£ Get the latest stable OpenSSL release from GitHub
      - name: Get latest OpenSSL release
        id: get_release
        shell: bash
        run: |
          # Fetch releases, filter out prerelease, get the latest tag
          LATEST=$(curl -s https://api.github.com/repos/openssl/openssl/releases \
            | jq -r 'map(select(.prerelease==false))[0].tag_name')
          echo "OPENSSL_VERSION=$LATEST" >> $GITHUB_ENV
          echo "Latest OpenSSL version detected: $LATEST"

      # 2Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 3Ô∏è‚É£ Install Strawberry Perl (ignore attestation verification)
      - name: Install Perl (Strawberry)
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: '5.36'
          verify: false

      # 4Ô∏è‚É£ Setup Visual Studio MSVC environment
      - name: Setup Visual Studio MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # 5Ô∏è‚É£ Download OpenSSL source
      - name: Download OpenSSL source
        shell: bash
        run: |
          echo "Downloading OpenSSL tag: $OPENSSL_VERSION"

          # Prefer the universal tags tarball URL which works for any tag name format
          URL="https://github.com/openssl/openssl/archive/refs/tags/${OPENSSL_VERSION}.tar.gz"
          echo "Fetching: $URL"

          # -f: fail on HTTP error; -L: follow redirects
          curl -fL -o openssl.tar.gz "$URL" || {
            echo "ERROR: download failed (HTTP error). Dumping response (for debugging):"
            # If curl wrote something, show it for debugging
            if [ -s openssl.tar.gz ]; then
              echo "--- start of downloaded file ---"
              head -n 50 openssl.tar.gz || true
              echo "--- end of downloaded file ---"
            else
              echo "No file was written by curl."
            fi
            exit 1
          }

          # Quick sanity check: ensure file is a gzip tarball
          if ! file openssl.tar.gz | grep -i 'gzip compressed data' >/dev/null 2>&1; then
            echo "ERROR: downloaded file is not a gzip archive:"
            file openssl.tar.gz
            echo "Dumping start of file to help debug:"
            head -n 50 openssl.tar.gz || true
            exit 1
          fi

          # Determine top-level directory in the tarball and extract
          TOPDIR=$(tar -tzf openssl.tar.gz | head -1 | cut -f1 -d"/")
          echo "Top directory in archive: $TOPDIR"
          tar -xzf openssl.tar.gz
          mv "$TOPDIR" openssl


      # 6Ô∏è‚É£ Configure OpenSSL build
      - name: Configure OpenSSL
        working-directory: openssl
        shell: cmd
        run: |
          if "%OPENSSL_BUILD_TYPE%"=="static" (
            perl Configure VC-WIN64A ^
              --prefix=%CD%\openssl_build ^
              --openssldir=%CD%\openssl_build\ssl ^
              no-tests ^
              no-asm ^
              no-shared
          ) else (
            perl Configure VC-WIN64A ^
              --prefix=%CD%\openssl_build ^
              --openssldir=%CD%\openssl_build\ssl ^
              no-tests ^
              no-asm
          )

      # 7Ô∏è‚É£ Build OpenSSL
      - name: Build OpenSSL
        working-directory: openssl
        shell: cmd
        run: nmake

      # 8Ô∏è‚É£ Install OpenSSL to relative path
      - name: Install OpenSSL
        working-directory: openssl
        shell: cmd
        run: nmake install

      # 9Ô∏è‚É£ Package the build artifacts
      - name: Package artifacts
        shell: powershell
        run: |
          Compress-Archive -Path "$PWD\openssl_build" -DestinationPath openssl-win64.zip

      # üîü Upload the artifact for later use
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: openssl-win64
          path: openssl-win64.zip
